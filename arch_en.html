<!DOCTYPE HTML>
<html lang="cn" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>AxVisor Overall Arch - AxVisor Architecture Book</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">AxVisor Architecture Book</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/arceos-hypervisor/doc" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="axvisor-the-unified-modular-hypervisor-based-on-arceos"><a class="header" href="#axvisor-the-unified-modular-hypervisor-based-on-arceos">AxVisor: The unified modular hypervisor based on <a href="https://github.com/arceos-org/arceos">ArceOS</a>.</a></h1>
<p><a href="https://github.com/orgs/arceos-hypervisor/discussions/7">discussion</a></p>
<!-- ## Design Goal -->
<p>This project originated from the <a href="https://github.com/orgs/rcore-os/discussions/13">discussion/13</a> of <a href="https://github.com/rcore-os">rCore-OS</a> community.</p>
<ul>
<li>
<p>add virtualization support crates/modules based on ArceOS unikernel</p>
</li>
<li>
<p>build a modular hypervisor that supports multiple architectures based on the basic OS functions</p>
</li>
<li>
<p>hope to make the hypervisor as modular as possible and minimize modifications to the arceos kernel code.</p>
</li>
</ul>
<h2 id="arceos"><a class="header" href="#arceos"><a href="https://github.com/arceos-org/arceos">ArceOS</a></a></h2>
<ul>
<li>An experimental modular OS in Rust.</li>
<li>basic architecture: <strong>unikernel</strong></li>
<li>modules/crates
<ul>
<li>kernel-dependent modules
<ul>
<li>axtask,axdriver,...</li>
</ul>
</li>
<li>Kernel-independent crates
<ul>
<li>buddy allocator, page_table...</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img src="./assets/arceos.png" alt="" /></p>
<h2 id="heterogeneous-expansion-based-on-arceos-kernel-components"><a class="header" href="#heterogeneous-expansion-based-on-arceos-kernel-components">Heterogeneous expansion based on arceos kernel components</a></h2>
<p><img src="./assets/arceos-hypervisor-architecture.png" alt="" /></p>
<ul>
<li>Kernel Backbone: arceos components</li>
<li>Monolithic  kernel extension: <a href="https://github.com/arceos-org/starry-next">starry-next</a>
<ul>
<li>process address space management</li>
<li>process abstraction</li>
<li>syscall support</li>
</ul>
</li>
<li>Hypervisor extension: <a href="https://github.com/arceos-hypervisor/arceos-umhv/">arceos-hypervisor</a>
<ul>
<li>VM address space management</li>
<li>emulated devices (interrupts, serial ports, etc.)</li>
<li>VM exit interface support</li>
</ul>
</li>
</ul>
<h2 id="arceos-umhv"><a class="header" href="#arceos-umhv">arceos-umhv</a></h2>
<p>Unified modular ArceOS hypervisor, mainly composed of the following independent components:</p>
<!-- * [vmm-app](https://github.com/arceos-hypervisor/arceos-umhv/tree/master/arceos-vmm): acts like a VMM (Virtual Machine Monitor)

* [axvm](https://github.com/arceos-hypervisor/arceos-umhv/tree/master/crates/axvm): responsible for **resource management** within each VM

* [axvcpu](https://github.com/arceos-hypervisor/axvcpu): provides CPU virtualization support


* [axdevice](https://github.com/arceos-hypervisor/axdevice): provides device emulation support


* [axaddrspace](https://github.com/arceos-hypervisor/axaddrspace): provides guest VM address space management -->
<ul>
<li>
<p><a href="https://github.com/arceos-hypervisor/arceos-umhv/tree/master/arceos-vmm">vmm-app</a></p>
</li>
<li>
<p><a href="https://github.com/arceos-hypervisor/arceos-umhv/tree/master/crates/axvm">axvm</a></p>
</li>
<li>
<p><a href="https://github.com/arceos-hypervisor/axvcpu">axvcpu</a></p>
</li>
<li>
<p><a href="https://github.com/arceos-hypervisor/axdevice">axdevice</a></p>
</li>
<li>
<p><a href="https://github.com/arceos-hypervisor/axaddrspace">axaddrspace</a></p>
</li>
</ul>
<p><img src="./assets/arceos-hypervisor-architecture.png" alt="" /></p>
<h2 id="components"><a class="header" href="#components">Components</a></h2>
<ul>
<li><a href="https://github.com/arceos-hypervisor/axvcpu">axvcpu</a>: provides CPU virtualization support
<ul>
<li>highly architecture-dependent</li>
<li>stores exception context frame of different architecture</li>
<li>basic scheduling item</li>
<li>arch-specific vcpu implementations need to be separated into separate crates:
<ul>
<li><a href="https://github.com/arceos-hypervisor/arm_vcpu">arm_vcpu</a></li>
<li><a href="https://github.com/arceos-hypervisor/x86_vcpu">x86_vcpu</a></li>
<li><a href="https://github.com/arceos-hypervisor/riscv_vcpu">riscv_vcpu</a></li>
<li>...</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="components-1"><a class="header" href="#components-1">Components</a></h2>
<ul>
<li><a href="https://github.com/arceos-hypervisor/axdevice">axdevice</a>: a module of ArceOS, provides device emulation support
<ul>
<li>partially architecture-independent</li>
<li>different emulated device implementations need to be separated into separate crates
<ul>
<li><a href="https://github.com/arceos-hypervisor/x86_vlapic">x86_vlapic</a></li>
<li><a href="https://github.com/arceos-hypervisor/arm_vgic">arm_vgic</a> (v2,v3,v4)</li>
<li>riscv_vplic</li>
<li>virtio-blk</li>
<li>virtio-net</li>
<li>...</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="components-2"><a class="header" href="#components-2">Components</a></h2>
<ul>
<li><a href="https://github.com/arceos-hypervisor/axaddrspace">axaddrspace</a>: provides guest VM address space management
<ul>
<li>nested page table implementation for different architectures</li>
<li>maybe combined with process virtual address space management</li>
<li>responsible for managing and mapping the guest VM's second-stage address space (GPA -&gt; HPA)</li>
<li>implemented based on ArceOS crates:
<ul>
<li><a href="https://crates.io/crates/page_table_entry">page_table_entry</a></li>
<li><a href="https://crates.io/crates/page_table_multiarch">page_table_multiarch</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="components-3"><a class="header" href="#components-3">Components</a></h2>
<ul>
<li><a href="https://github.com/arceos-hypervisor/arceos-umhv/tree/master/crates/axvm">axvm</a>: responsible for <strong>resource management</strong> within each VM
<ul>
<li>partially architecture-independent</li>
<li>a instance of guest virtual machine</li>
<li>resources:
<ul>
<li>address space of guest VM</li>
<li>axvcpu list</li>
<li>axdevice list</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="components-4"><a class="header" href="#components-4">Components</a></h2>
<ul>
<li><a href="https://github.com/arceos-hypervisor/arceos-umhv/tree/master/arceos-vmm">vmm-app</a>: acts like a VMM (Virtual Machine Monitor)
<ul>
<li>As an ArceOS unikernel app, directly call arceos functions</li>
<li>completely architecture-independent</li>
<li>responsible for VM management (configuration &amp; runtime)</li>
</ul>
</li>
</ul>
<h2 id="vcpu-scheduling--based-on-axtask"><a class="header" href="#vcpu-scheduling--based-on-axtask">VCpu Scheduling : based on axtask</a></h2>
<!-- axvcpu is just and only reponsible virtualization function support, e.g. enter/exit guest VM through vmlaunch/vmexit.

Since ArceOS already provides axtask for runtime control flow mangement under single privilege level, 
we can reuse its scheduler and evolve with it.

VCpu scheduling upon ArceOS may looks like this: -->
<pre><code class="language-Rust">    for vcpu in vm.vcpu_list() {
        axtask::spawn(|| {
                let curr = axtask::current();
                let vcpu = unsafe { curr.task_ext().vcpu.clone() };
                let vm = unsafe { curr.task_ext().vm.clone() };
                loop {
                    let exit_reason = vcpu.run();
                    match exit_reason {
                        MMIO(emu_ctx) =&gt; vm.handle_device(emu_ctx),
                        HVC(emu_ctx) =&gt; vm.handle_hvc(emu_ctx),
                        EXIT(code) =&gt; axtask::exit(code),
                        ...
                    }
                }
            }
        );
    }
</code></pre>
<!-- * converge all interactions with the guest privilege level within the `vcpu.run()` function, so that a `loop` block can handle all access from guest VM. -->
<h3 id="exception-vm-exit-handling"><a class="header" href="#exception-vm-exit-handling">Exception (VM-Exit) Handling</a></h3>
<p>The vcpu scheduling design mentioned above requires a reasonable exception (VM-Exit) handling framework.</p>
<ul>
<li>x86_64
<ul>
<li>host-state area of the VMCS can flexibly determine the <code>rip</code> value after a VM-Exit occurs</li>
<li>Therefore, we can save the context properly in the host sp during <code>vmlaunch/resume</code>, store the host sp pointer, and pop the context from the host sp in the <code>vmx_exit</code> function when a VM-Exit occurs. All of these operations are performed in vmx mod, which elegantly limits the interaction with the guest VM to the <code>vcpu.run()</code> function.</li>
</ul>
</li>
</ul>
<h3 id="exception-vm-exit-handling-1"><a class="header" href="#exception-vm-exit-handling-1">Exception (VM-Exit) Handling</a></h3>
<p>The vcpu scheduling design mentioned above requires a reasonable exception (VM-Exit) handling framework.</p>
<ul>
<li>
<p>aarch64</p>
<ul>
<li><a href="https://developer.arm.com/documentation/ddi0601/2020-12/AArch64-Registers/VBAR-EL2--Vector-Base-Address-Register--EL2-"><code>VBAR_EL2</code></a> register holds the vector base address</li>
<li>to run arceos in EL2 to support virtualization, we need to make intrusive modifications to arceos's <a href="https://github.com/arceos-org/arceos/tree/main/modules/axhal">axhal module</a>.</li>
<li>save callee saved registers in EL2's stack manually</li>
</ul>
  <!-- * For VM-Entry
      * `arch_vcpu.run()`
      * save callee saved registers (EL2)
      * pass context frame pointer, something like `&vcpu.vm_context_frame`
      * recore VM context from `&vcpu.vm_context_frame`, including
          * status register
          * general register
      * eret
  * For VM-Exit
      * exception handler
      * get pointer of current vcpu's context frame pointer
      * store VM context into `&current_vcpu.vm_context_frame`, including
          * status register
          * general register
      * pop callee saved registers (EL2)
      * back to `arch_vcpu.run()` -->
</li>
</ul>
<h3 id="multilayer-vm-exit-handling"><a class="header" href="#multilayer-vm-exit-handling">Multilayer VM-Exit handling</a></h3>
<p>VM-Exits in x86_64, aarch64 and riscv64 follow the same design logic but share a slightly different implementation.</p>
<ul>
<li>Inner-VCpu handling
<ul>
<li>e.g. under x86_64, some VM-Exit items are architecture specific (<code>CR_ACCESS</code>, <code>CPUID</code>)</li>
</ul>
</li>
<li>Inner-VM handling
<ul>
<li>leaving device emulation related and page-fault related VM-Exits inside axvm</li>
</ul>
</li>
<li>(Outer-VM)vmm-app handling
<ul>
<li>including the handling of hypercalls (handling this within the VMM also seems quite reasonable) and any (if-any) VM-Exit types that require vCPU scheduling or vCPU exit</li>
</ul>
</li>
</ul>
<!-- 

### Exception Type (VM-Exit Reason)

* architecture independent
* reference: [KVM exit reasion](https://docs.rs/kvm-ioctls/0.17.0/kvm_ioctls/enum.VcpuExit.html)
* current implementation [crates/axvm/src/vcpu.rs](https://github.com/arceos-hypervisor/arceos-umhv/blob/master/crates/axvm/src/vcpu.rs) -->
<h2 id="memory-management"><a class="header" href="#memory-management">Memory Management</a></h2>
<ul>
<li>
<p>similar to the address space management of the <a href="https://github.com/arceos-org/arceos/tree/monolithickernel-new/">arceos-monolithic</a>.</p>
</li>
<li>
<p>take advantage of crate <a href="https://github.com/arceos-org/arceos/tree/monolithickernel-new/crates/memory_set">memory_set</a> and register the PageTable as our <a href="https://github.com/arceos-hypervisor/arceos-umhv/blob/master/crates/axvm/src/mm/npt.rs">AxNestPageTable</a>.</p>
</li>
</ul>
<pre><pre class="playground"><code class="language-rust edition2021"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// The virtual memory address space.
pub struct AddrSpace&lt;H: PagingHandler&gt; {
    va_range: GuestPhysAddrRange,
    areas: MemorySet&lt;Backend&lt;H&gt;&gt;,
    pt: PageTable&lt;H&gt;,
}
<span class="boring">}</span></code></pre></pre>
<blockquote>
<p>we hope to find a way to unify address space management for both monolithic and hypervisor variants of ArceOS.</p>
</blockquote>
<h2 id="emulated-device"><a class="header" href="#emulated-device">Emulated Device</a></h2>
<p><code>axdevice</code> crate provides struct like <code>AxEmulatedDevices</code>, which will be owned and managed by <code>AxVM</code>.</p>
<pre><code class="language-Rust">pub struct AxEmulatedDevices {
    mmio_devices: BTreeMap&lt;Range&lt;usize&gt;, dyn EmuDev&gt;,
    #[cfg(target_arch = "x86_64")]
    pio_devices: BTreeMap&lt;Range&lt;usize&gt;, dyn EmuDev&gt;,
}

pub trait EmuDev {
    fn emu_type(&amp;self) -&gt; EmuDeviceType;
    fn address_range(&amp;self) -&gt; Range&lt;usize&gt;;
    fn handler(&amp;self, ctx: &amp;AccessContext) -&gt; AxResult;
}
</code></pre>
<!-- When a VM-Exit caused by MMIO (or PIO) access occurs, `axvcpu` will record the current access information, including address, bit width, read/write, etc. The `emulated_device_handler` function of axdevice needs to find the corresponding emulated device according to the access address, call the corresponding device's processing function and pass in the access information.

Providing emulated device support for guest VMs requires considerable work.
Currently we focus on [emulated interrupt controller](https://github.com/arceos-hypervisor/arceos-hypervisor-docs/blob/master/devices/emulated_interrupt_controller.md) for different architectures and virtio-devices (mainly [Virtio-Blk](https://github.com/arceos-hypervisor/arceos-hypervisor-docs/blob/master/devices/virtio_blk.md)). -->
<h2 id="dependency-diagram"><a class="header" href="#dependency-diagram">Dependency diagram</a></h2>
<p><img src="./assets/arceos-hv-dep.svg" alt="" /></p>
<!-- * Note: we aim to consolidate all dependencies on ArceOS within the vmm-app -->
<p>Since modules/crates used for virtualization functionality in the ArceOS-Hypervisor architecture need to call OS-related resource management interfaces, <strong>while we aim to consolidate all OS-related dependencies within the vmm-app</strong>.</p>
<p>Various modules/crates will achieve dependency injection through Rust traits.</p>
<h2 id="example-about-how-we-achieve-dependency-injection"><a class="header" href="#example-about-how-we-achieve-dependency-injection">Example about how we achieve dependency injection</a></h2>
<p>Taking <a href="https://github.com/arceos-hypervisor/axaddrspace"><code>axaddrspace</code></a> for an example, its <a href="https://github.com/arceos-hypervisor/axaddrspace/blob/d377e5aa4eb06afa50a3a901ec3239559be1eb51/src/address_space.rs#L16C12-L16C21"><code>AddrSpace</code></a> represents memory regions and two-stage address mapping for guest VM, which relies on a generic type <code>PagingHandler</code> for page table related stuff.</p>
<pre><code class="language-Rust">/// The virtual memory address space.
pub struct AddrSpace&lt;H: PagingHandler&gt; {
    va_range: VirtAddrRange,
    areas: MemorySet&lt;MappingFlags, PageTable&lt;H&gt;, Backend&gt;,
    pt: PageTable&lt;H&gt;,
}
</code></pre>
<h2 id="example-about-how-we-achieve-dependency-injection-1"><a class="header" href="#example-about-how-we-achieve-dependency-injection-1">Example about how we achieve dependency injection</a></h2>
<p><code>axaddrspace</code> is owned and managed by <code>axvm</code>'s <code>AxVM</code> structure, which replies on <code>AxVMHal</code> trait ( defined in <code>axvm</code>'s <a href="https://github.com/arceos-hypervisor/axvm/blob/master/src/hal.rs">hal.rs</a> ) .</p>
<p>Indeed, <code>PagingHandler</code> is a associate type of <code>AxVMHal</code> trait.</p>
<pre><code class="language-Rust">/// The interfaces which the underlying software (kernel or hypervisor) must implement.
pub trait AxVMHal: Sized {
    type PagingHandler: page_table_multiarch::PagingHandler;
    /// Converts a virtual address to the corresponding physical address.
    fn virt_to_phys(vaddr: HostVirtAddr) -&gt; HostPhysAddr;
    /// Current time in nanoseconds.
    fn current_time_nanos() -&gt; u64;
	// ...
}
</code></pre>
<h2 id="example-about-how-we-achieve-dependency-injection-2"><a class="header" href="#example-about-how-we-achieve-dependency-injection-2">Example about how we achieve dependency injection</a></h2>
<p>While <code>AxVMHal</code> is implemented by <code>AxVMHalImpl</code> in vmm-app, which rely on <code>PagingHandlerImpl</code> from <code>ArceOS</code>'s <code>axhal</code> module to implement its associate type <code>PagingHandler</code>.</p>
<pre><code class="language-Rust">pub struct AxVMHalImpl;

impl AxVMHal for AxVMHalImpl {
    type PagingHandler = axhal::paging::PagingHandlerImpl;
    fn virt_to_phys(vaddr: VirtAddr) -&gt; PhysAddr {
        axhal::mem::virt_to_phys(vaddr)
    }
    fn current_time_nanos() -&gt; u64 {
        axhal::time::monotonic_time_nanos()
    }
	// ...
}
</code></pre>
<h2 id="dependency-injection"><a class="header" href="#dependency-injection">Dependency injection</a></h2>
<p>So, current design achieve dependency injection through Rust's generic type (<code>Trait</code>) and its associate type mechanism.</p>
<p>For other virtualization-related modules/crates such as <code>axvcpu</code>, <code>axdevice</code>, etc.,
we also want them to expose well-designed generics, and to converge these carefully crafted generics as subtraits or associated types within the <code>AxVmHal trait</code> of <code>axvm</code> (since <code>axvm</code> is reponsible for VM resource management).</p>
<p>Ultimately, the <code>vmm-app</code> layer will call the relevant functionalities of <code>ArceOS</code> to implement them.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="arch_cn.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="gvm.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="arch_cn.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="gvm.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>

        <script src="ace.js"></script>
        <script src="editor.js"></script>
        <script src="mode-rust.js"></script>
        <script src="theme-dawn.js"></script>
        <script src="theme-tomorrow_night.js"></script>

        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->
        <script src="mermaid.min.js"></script>
        <script src="mermaid-init.js"></script>


    </div>
    </body>
</html>
